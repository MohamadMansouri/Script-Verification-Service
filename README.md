# Script Verification Service

A server that verifies the signature of bash scripts using self-signed certificates. The signature of the script should be embedded at the first line of the script in base64 and generated by signing the sha256 hash of the original script. The server uses named pipes to receive scripts from other processes. In particular it creates a fifo pipe and reads from it. Signed scripts can be sent to the server by writing to the named pipe. For each file received, the server verifies the signature of the file using a set of certificates. The certificates are read from a path which can be configured. The server only accepts certificates that are self-signed and there Key Usage and Extended Key Usage fields include digitalSignature and codeSigning respectively. If a script is received with a valid signature, the server prints the output of the signature to stdout.

## Pre-requisites

- libssl-dev libraries installed (version supporting X509 V3)
- openssl cmd line tools for generating tests
- build-essential to build the server

## Building

- run `make`

## Usage

```
./server [-d] [-c <certs_path>]
       -d : enable debug
       -c <certs_path> : specify certificates directory (default: ./tests/certificates)
```
The FIFO name pipe ./fifo will be created. To send scripts to the server you can use `cat example.sh > fifo`

## Generating tests

- In directory `tests/tools` run `./generate_certs.sh`.

    - This will create the directory `tests/keys` and generate a set of private keys in it. The set of generated private keys are of type:
    
        -  RSA 2048
        -  RSA 4096
        -  DSA 2048
        -  EDDSA on curve ED448

    - It also creates the directory `tests/certificates` and generate a set of certificates. The set of the generated certificates are:

        - **Self-signed** certificate with **RSA 4096** key and digest sha256 **with** Key Usage and Extended Key Usage set to 'digitalSignature' and 'codeSigning'
        - **Self-signed** certificate with **RSA 2048** key and digest sha512 **with** Key Usage and Extended Key Usage set to 'digitalSignature' and 'codeSigning'
        - **Self-signed** certificate with **DSA 2048** key and digest sha256 **with** Key Usage and Extended Key Usage set to 'digitalSignature' and 'codeSigning'
        - **Self-signed** certificate with **ED448** key **with** Key Usage and Extended Key Usage set to 'digitalSignature' and 'codeSigning'
        - Certificate with **RSA 2048** key signed by RSA 4096 **with** Key Usage and Extended Key Usage set to 'digitalSignature' and 'codeSigning'
        - **Self-signed** certificate with **RSA 2048** key and digest sha512 **without** Key Usage and Extended Key Usage set to 'digitalSignature' and 'codeSigning'

- In directory `tests/tools` run `./sign_scripts.sh`. This will sign the 3 testing scripts in `tests/scripts` as follows

    -  `tests/scripts/script.sh` is signed with RSA 4096 and `tests/scripts/script.sh.signed` is generated
    -  `tests/scripts/script_long_input.sh` is signed with RSA 2048 and `tests/scripts/script_long_input.sh.signed` is generated
    -  `tests/scripts/script_long_output.sh` is signed with DSA 2048 and `tests/scripts/script_long_output.sh.signed` is generated

## Testing

- run the server: `./server`
- send signed scripts to it, for example: `cat tests/scripts/script.sh.signed > fifo`

The output of the script will be printed to stdout of the server process. A sample output is:

```
INFO : Successfully loaded certificate dsa_2048_sha512_cert.pem
INFO : Successfully loaded certificate rsa_4096_sha256_cert.pem
INFO : Successfully loaded certificate rsa_2048_sha512_cert.pem
INFO : Successfully loaded certificate eddsa_448_sha256_cert.pem
INFO : Loaded a total of 4 certificates
INFO :  
INFO :  
INFO : ============================================
INFO : ========== Received script #1 ==============
INFO : ============================================
INFO : Script #1 has VALID signature, executing...
INFO : ++++++++++++ SCRIPT OUTPUT ++++++++++++++++
INFO : ++++++++++++++++ START ++++++++++++++++++++
Mon Jun 17 01:24:09 AM CEST 2024
/home/mmrota/Documents/CA2
mmrota
INFO : +++++++++++++++++ END +++++++++++++++++++++
INFO : +++++++++++++++++++++++++++++++++++++++++++
```

## Future work

- Allow the server to run multiple threads. Each thread will open a different named pipe and will have its own copy of `signed_script_t` structure to work on. The certificate container will be shared but it will be read only for all threads. Threads should implement locks on producing the output to have a nicely readable result.

- Use websockets as an option for IPC instead of named pipes. Consider saving size by implementing two high level functions `init_ipc` (called before the loop) and `read_from_ipc` (called inside the loop).